# 4.3 系统功能的实现（扩展）

本文档扩展并详细说明 CookieShop 项目中第 4.3 节“系统功能的实现”，包括前台和后台各模块的实现步骤、涉及的模型类、JSP 页面、控制器 Servlet、Service 与 DAO，关键方法代码片段说明，以及测试/截图占位说明。

> 文件位置：`docs/系统功能实现_4.3.md`

---

## 4.3 总体介绍与模块划分

系统分为前台（用户）和后台（管理员）两大部分：

- 前台模块（用户可见）
  - 用户注册（Register）
  - 用户登录（Login）
  - 购物车（Cart / Order）
  - 商品分类查询（Category）
  - 商品搜索（Search）

- 后台模块（管理员）
  - 商品管理（Goods Management）
  - 订单管理（Order Management）
  - 客户管理（User Management）
  - 商品类目管理（Type Management）

模块图（文字版）：

USER（前端） <--> GOODS / TYPE / RECOMMEND

USER → ORDER → ORDERITEM (购物车/下单流程)

ADMIN（后台） 管理 GOODS / ORDER / USER / TYPE

---

## 4.3.1 系统前端的设计与实现

下面对每个子模块说明实现步骤：模型类、JSP、Servlet、Service、DAO 的对应关系、关键方法与测试步骤。

说明：每个模块先给出“要点”，再列出关键文件路径与示例代码片段。

### (1) 用户注册功能

要点：读取表单参数，封装为 `model.User`，调用 `service.UserService.register()`，注册成功跳转登录页，失败返回注册页并显示提示。

关键文件：
- 模型：`src/model/User.java`
- JSP 页面：`web/user_register.jsp`
- 控制器 Servlet：`src/servlet/UserRegisterServlet.java`（映射 `/user_rigister`）
- Service：`src/service/UserService.java`
- DAO：`src/dao/UserDao.java`

关键代码片段（核心逻辑）：
- `UserRegisterServlet.doPost`（已存在）使用 BeanUtils 填充 User 并调用 uService.register(user)：

```java
// 关键逻辑 (摘自 UserRegisterServlet)
User user = new User();
BeanUtils.copyProperties(user, request.getParameterMap());
if(uService.register(user)) {
    request.setAttribute("msg", "注册成功，请登录！");
    request.getRequestDispatcher("user_login.jsp").forward(request, response);
} else {
    request.setAttribute("msg", "用户名或邮箱重复，请重新填写！");
    request.getRequestDispatcher("user_register.jsp").forward(request, response);
}
```

- `UserService.register`：先检查用户名与邮箱是否存在（调用 `UserDao.isUsernameExist` / `isEmailExist`），不存在时调用 `UserDao.addUser`

测试步骤（截图占位）:
1. 打开 `http://localhost:8080/user_register.jsp`
2. 填写用户名/邮箱/密码等，点击提交。
3. 截图：成功提示页面 `/user_login.jsp` 或失败的错误提示。

截图占位说明：在文档末尾插入图片（例如 `screenshots/register_success.png`）

---

### (2) 用户登录功能

要点：支持用户名或邮箱登录，登录成功将 `User` 放入 session（`session.setAttribute("user", user)`），并跳转用户中心。

关键文件：
- JSP 页面：`web/user_login.jsp`
- 控制器 Servlet：`src/servlet/UserLoginServlet.java`（映射 `/user_login`）
- Service：`src/service/UserService.java`
- DAO：`src/dao/UserDao.java`（含 `selectByUsernamePassword`、`selectByEmailPassword`）

关键代码片段：

```java
// UserLoginServlet.doPost (摘录)
String ue = request.getParameter("ue");
String password = request.getParameter("password");
User user = uService.login(ue, password);
if(user==null) {
    request.setAttribute("failMsg", "用户名、邮箱或者密码错误，请重新登录！");
    request.getRequestDispatcher("/user_login.jsp").forward(request, response);
} else {
    request.getSession().setAttribute("user", user);
    request.getRequestDispatcher("/user_center.jsp").forward(request, response);
}
```

测试步骤（截图占位）:
1. 打开 `http://localhost:8080/user_login.jsp`
2. 使用已存在用户（例如数据库中的 `admin/admin`）登录。
3. 截图：登录后 `user_center.jsp` 页面。

注意：若要访问 `/admin/*` 后台页面，需要在数据库创建管理员用户（见文档后面的 SQL）。

---

### (3) 购物车功能

要点：将购物行为暂存在 `Order` 对象（存在于 session）中，通过 `GoodsBuyServlet` 增加商品、通过 `order_submit` 提交订单。前端展示在 `web/goods_cart.jsp`。

关键文件：
- 模型：`src/model/Order.java`, `src/model/OrderItem.java`, `src/model/Goods.java`
- JSP 页面：`web/goods_cart.jsp`
- 控制器 Servlet：`src/servlet/GoodsBuyServlet.java`（映射 `/goods_buy`）
- Service/DAO：`GoodsService` / `GoodsDao`（检查库存并查询商品详情），以及 `OrderService` / `OrderDao`（提交并保存订单）

关键代码片段（添加到购物车）：

```java
// GoodsBuyServlet.doPost (摘录)
Order o = (Order) request.getSession().getAttribute("order");
if(o==null){ o = new Order(); request.getSession().setAttribute("order", o); }
int goodsid = Integer.parseInt(request.getParameter("goodsid"));
Goods goods = gService.getGoodsById(goodsid);
if(goods.getStock()>0) {
    o.addGoods(goods);
    response.getWriter().print("ok");
} else {
    response.getWriter().print("fail");
}
```

前端展示：`goods_cart.jsp` 使用 `${order.itemMap}` 遍历并显示项，提供增加/减少/删除的按钮。

测试步骤（截图占位）:
1. 登录用户 → 在商品列表点击“加入购物车”按钮（或直接访问商品详情，增加商品）。
2. 打开 `http://localhost:8080/goods_cart.jsp` 查看购物车内容并截图。

---

### (4) 商品分类查询功能

要点：按 `type_id` 查询商品并分页显示。前端商品列表页 `goods_list.jsp`，后端由 `GoodsListServlet` / `GoodsService.selectPageByTypeID` 实现分页。

关键文件：
- Servlet：`src/servlet/GoodsListServlet.java`（映射 `/goods_list`）
- Service：`src/service/GoodsService.java` （`selectPageByTypeID`）
- DAO：`src/dao/GoodsDao.java`（`selectGoodsByTypeID`，`getCountOfGoodsByTypeID`）
- JSP：`web/goods_list.jsp`

关键代码片段（Service）：

```java
// GoodsService.selectPageByTypeID (摘录)
Page p = new Page();
p.setPageNumber(pageNumber);
int totalCount = gDao.getCountOfGoodsByTypeID(typeID);
p.SetPageSizeAndTotalCount(8, totalCount);
List list = gDao.selectGoodsByTypeID(typeID, pageNumber, 8);
p.setList(list);
return p;
```

测试步骤（截图占位）:
1. 打开 `http://localhost:8080/goods_list?typeid=2`（或首页分类链接）。
2. 截图：分页列表界面 `goods_list.jsp`。

---

### (5) 商品搜索功能

要点：通过关键字模糊查询 `goods.name like '%keyword%'`，由 `GoodsSearchServlet` 处理并转发 `goods_search.jsp`。

关键文件：
- Servlet：`src/servlet/GoodsSearchServlet.java`（映射 `/goods_search`）
- Service：`src/service/GoodsService.java`（`getSearchGoodsPage` / `selectSearchGoods`）
- DAO：`src/dao/GoodsDao.java`（`getSearchCount`、`selectSearchGoods`）
- JSP：`web/goods_search.jsp`

关键代码片段（Servlet）：

```java
String keyword = request.getParameter("keyword");
int pageNumber = ...;
Page p = gService.getSearchGoodsPage(keyword,pageNumber);
request.setAttribute("p", p);
request.setAttribute("keyword", URLEncoder.encode(keyword,"utf-8"));
request.getRequestDispatcher("/goods_search.jsp").forward(request, response);
```

测试步骤（截图占位）:
1. 在首页输入关键词并提交搜索。
2. 截图：搜索结果 `goods_search.jsp`。

---

## 4.3.2 系统后台的设计与实现

后台模块由 AdminFilter（`src/filter/AdminFilter.java`）统一拦截 `/admin/*` 路径，必须在前台登录并且 `user.isIsadmin()==true` 才可访问。下面列出各后台子模块的实现要点。

> 注意：若后台不可访问，请先在数据库中创建管理员账号（例 SQL 在本节末尾）。

### (1) 商品管理功能（管理员）

要点：后台商品列表、添加、编辑、删除、设置推荐位等。管理员列表页为 `web/admin/goods_list.jsp`，由 `AdminGoodsListServlet` 提供数据。

关键文件：
- JSP：`web/admin/goods_list.jsp`, `web/admin/goods_add.jsp`, `web/admin/goods_edit.jsp` 等
- Servlet：`src/servlet/AdminGoodsListServlet.java`, `AdminGoodsAddServlet.java`, `AdminGoodsEditServlet.java`, `AdminGoodsDeleteServlet.java`, `AdminGoodsRecommendServlet.java`
- Service：`src/service/GoodsService.java`
- DAO：`src/dao/GoodsDao.java`
- 模型：`src/model/Goods.java`, `src/model/Recommend.java`

关键代码片段（列表 Servlet）：

```java
// AdminGoodsListServlet.doGet (摘录)
int type = 0; // 推荐类型
int pageNumber = ...;
Page p = gService.getGoodsRecommendPage(type, pageNumber);
request.setAttribute("p", p);
request.setAttribute("type", type);
request.getRequestDispatcher("/admin/goods_list.jsp").forward(request, response);
```

测试步骤（截图占位）:
1. 登录管理员 → 访问 `http://localhost:8080/admin/goods_list`。
2. 截图：后台商品管理列表。

---

### (2) 订单管理功能（管理员）

要点：订单按状态筛选、查看详情、修改状态、删除订单。

关键文件：
- JSP：`web/admin/order_list.jsp`
- Servlet：`src/servlet/AdminOrderListServlet.java`, `AdminOrderStatusServlet.java`, `AdminOrderDeleteServlet.java`
- Service：`src/service/OrderService.java`
- DAO：`src/dao/OrderDao.java`
- 模型：`src/model/Order.java`, `src/model/OrderItem.java`

关键代码片段（列表 Servlet）：

```java
// AdminOrderListServlet.doGet (摘录)
int status = 0; // 例如 1/2/3/4
Page p = oService.getOrderPage(status, pageNumber);
request.setAttribute("p", p);
request.getRequestDispatcher("/admin/order_list.jsp").forward(request, response);
```

测试步骤（截图占位）:
1. 管理员登录 → 访问 `http://localhost:8080/admin/order_list`。
2. 截图：订单列表与订单状态变更操作页面。

---

### (3) 客户管理功能（管理员）

要点：分页查看用户、添加/编辑/删除/重置密码等。

关键文件：
- JSP：`web/admin/user_list.jsp`, `web/admin/user_add.jsp`, `web/admin/user_edit.jsp`, `web/admin/user_reset.jsp`
- Servlet：`src/servlet/AdminUserListServlet.java`, `AdminUserAddServlet.java`, `AdminUserEditServlet.java`, `AdminUserDeleteServlet.java`, `AdminUserResetServlet.java`
- Service：`src/service/UserService.java`
- DAO：`src/dao/UserDao.java`

关键代码片段（UserService.getUserPage）：

```java
// UserService.getUserPage (摘录)
Page p = new Page();
p.setPageNumber(pageNumber);
int pageSize = 7;
int totalCount = uDao.selectUserCount();
p.SetPageSizeAndTotalCount(pageSize, totalCount);
List list = uDao.selectUserList(pageNumber, pageSize);
p.setList(list);
return p;
```

测试步骤（截图占位）:
1. 管理员登录 → 访问 `http://localhost:8080/admin/user_list`。
2. 截图：用户列表及操作按钮截图。

---

### (4) 商品类目管理功能（Type 管理）

要点：管理商品分类（增删改）。后台 `AdminTypeListServlet` 会将类型列表放入 `ServletContext`，以便前台展示分类导航。

关键文件：
- JSP：`web/admin/type_list.jsp`, `web/admin/type_add.jsp`, `web/admin/type_edit.jsp`
- Servlet：`src/servlet/AdminTypeListServlet.java`, `AdminTypeAddServlet.java`, `AdminTypeEditServlet.java`, `AdminTypeDeleteServlet.java`
- Service：`src/service/TypeService.java`
- DAO：`src/dao/TypeDao.java`
- 模型：`src/model/Type.java`

关键代码片段（AdminTypeListServlet）：

```java
List<Type> list= tService.GetAllType();
request.setAttribute("list", list);
this.getServletContext().setAttribute("typeList",list);
request.getRequestDispatcher("/admin/type_list.jsp").forward(request, response);
```

测试步骤（截图占位）:
1. 管理员登录 → 访问 `http://localhost:8080/admin/type_list`。
2. 截图：类型列表与“添加/编辑/删除”操作页面。

---

## 管理员账号（快速创建 SQL）

如果后台页面被 `AdminFilter` 拦截，请在 MySQL 中创建管理员用户：

```sql
INSERT INTO `user` (username, email, password, name, phone, address, isadmin, isvalidate)
VALUES ('admin', 'admin@cookieshop.com', '123456', '系统管理员', '13800138000', '公司地址', b'1', b'1');
```

登录后访问：`/admin/goods_list`、`/admin/order_list`、`/admin/user_list`、`/admin/type_list`。

---

## 关键测试用例与截图建议

请按下列顺序截图（每项为一张或多张图）并保存到 `docs/screenshots/` 下：
1. `user_register.jsp` 提交并显示“注册成功”提示（register_success.png）
2. `user_login.jsp` 登录成功后 `user_center.jsp`（login_success.png）
3. 向购物车加入商品并在 `goods_cart.jsp` 查看（cart_view.png）
4. `goods_list.jsp` 分类查询及分页（category_list.png）
5. `goods_search.jsp` 搜索结果（search_result.png）
6. 管理员 `admin/goods_list`（admin_goods_list.png）
7. 管理员 `admin/order_list`（admin_order_list.png）
8. 管理员 `admin/user_list`（admin_user_list.png）
9. 管理员 `admin/type_list`（admin_type_list.png）

截图占位：在 Markdown 中使用 `![desc](screenshots/xxx.png)` 引入。

---

## 可扩展建议（短期可做的增强）

1. 密码使用哈希存储（例如 bcrypt），不要以明文放进数据库。修改 `UserDao.addUser` 与登录验证逻辑。
2. 表单校验（前端 JS + 后端校验），避免空值与注入。
3. 为重要查询添加事务控制（Order 提交流程）。
4. 将文件路径或常量配置化，避免硬编码 `"/user_rigister"` 等字符串分散。
5. 添加单元测试（DAO 层的集成测试），用小数据库 fixture 进行验证。

---

## 结语

我已把扩展后的 4.3 系统功能实现文档保存为：

`c:\Program Files\Apache Software Foundation\Tomcat 9.0\webapps\CookieShop\docs\系统功能实现_4.3.md`

如果您希望我：
- 将关键方法的完整源码片段（超过 1 个方法）插入文档 → 我可以把更长的代码段自动摘录并替换占位。
- 自动生成并嵌入实际运行截图（需要您允许我运行 Tomcat & 浏览器，或您上传截图） → 我可以把截图占位替换为真实图片。
- 将该文档合并进 `综合实验报告_...md` 的 4.3 节 → 我可以替您合并（会修改现有文件）。

请选择下一步（例如：插入更多代码片段 / 合并到主报告 / 添加截图）。